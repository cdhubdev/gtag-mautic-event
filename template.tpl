___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "categories": [
    "MARKETING",
    "EMAIL_MARKETING"
  ],
  "securityGroups": [],
  "displayName": "Mautic Event",
  "brand": {
    "id": "brand_Suagencia",
    "displayName": "Suagencia",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Add page view or custom events in Mautic. Recommended to be used to trigger additional events, after initialization of mautic tracking (see Mautic with consent tag)",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "mautic_url",
    "displayName": "mautic domain",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "page_url",
    "displayName": "Page URL",
    "simpleValueType": true,
    "help": "include a custom string as the url, or leave it empty to use the original page\u0027s url"
  },
  {
    "type": "TEXT",
    "name": "page_title",
    "displayName": "Page Title",
    "simpleValueType": true,
    "help": "include a custom string as the page title, or leave it empty to use the original page\u0027s title"
  },
  {
    "type": "TEXT",
    "name": "tags",
    "displayName": "Tags",
    "simpleValueType": true,
    "help": "separate different tags with comma, use the minus sign to remove a tag (eg:  addThisTag,-removeThisTag)"
  },
  {
    "type": "PARAM_TABLE",
    "name": "public_fields",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "field_name",
          "displayName": "Field Name",
          "simpleValueType": true
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "field_value",
          "displayName": "Field Value",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ],
    "displayName": "Update Public Fields",
    "help": "You can also pass information specific to your Contact by setting Mautic Contact field(s) to be publicly updatable."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
const readTitle = require('readTitle');
const getUrl = require('getUrl');
const encodeUriComponent = require('encodeUriComponent');
const sendPixel = require('sendPixel');
log('data =', data);

const makeTableMap = require('makeTableMap' );



let pixelURL = ""; //data.mautic_url +"/mtacking.gif?";

pixelURL += "page_url=";
pixelURL += data.page_url == undefined?encodeUriComponent(getUrl()):encodeUriComponent(data.page_url);
pixelURL += "&page_title=";
pixelURL += data.page_title == undefined?encodeUriComponent(readTitle()):encodeUriComponent(data.page_title);

log(pixelURL);

if( data.tags !== undefined ) {
  pixelURL += "&tags=" + encodeUriComponent(data.tags);
}

if( data.public_fields !== undefined ) {
  const public_fields = makeTableMap(data.public_fields, "field_name","field_value");
  log(public_fields);
  for( let key in public_fields ){
    pixelURL += "&" + key +"=";
    pixelURL += encodeUriComponent(public_fields[key]);
  }
}
pixelURL = data.mautic_url +"/mtracking.gif?" + pixelURL;
log(pixelURL);
sendPixel(pixelURL);
// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_title",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: basic
  code: "const mockData = {\n  mautic_url:\"https://mkt.solutta.com\",\n  page_url:\"\
    page/test\",\n  page_title:\"Pagina Teste\",\n  tags:\"tag1,-tag2\",\n  public_fields:[\n\
    \    {field_name:\"field1\",field_value:\"value1\"},\n    {field_name:\"field2\"\
    ,field_value:\"value2\"},\n    {field_name:\"field3\",field_value:\"value3\"},\n\
    \     \n  ]\n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: NoPublicFields
  code: |-
    const mockData = {
      mautic_url:"https://mkt.solutta.com",
      page_url:"page/test",
      page_title:"Pagina Teste",
      tags:"tag1,-tag2",
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 1/4/2022, 11:27:10 PM


